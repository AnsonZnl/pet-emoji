# Pet Emoji Generator 技术文档

## 项目概述

Pet Emoji Generator 是一个基于 AI 的宠物表情包生成器，用户可以上传宠物照片，通过 AI 技术生成各种风格的表情包。项目已移除测试模式，专注于生产环境的稳定运行。

## 技术栈

### 前端
- **框架**: Next.js 15.5.3 (App Router)
- **语言**: TypeScript 5
- **样式**: Tailwind CSS 4
- **UI组件**: React 19.1.0
- **状态管理**: React Hooks (useState, useCallback)
- **字体**: Geist Sans & Geist Mono

### 后端
- **API**: Next.js API Routes
- **AI服务**: 豆包大模型 (doubao-seedream-4-0-250828)
- **文件存储**: Cloudflare R2
- **数据库**: Supabase (PostgreSQL)
- **AWS SDK**: @aws-sdk/client-s3 v3.888.0

### 部署与SEO
- **平台**: Vercel
- **域名**: https://www.petemojimaker.com
- **CDN**: Cloudflare
- **SEO**: 完整的元数据、结构化数据、sitemap
- **PWA**: 支持 manifest.json

## 项目结构

```
pet-emoji/
├── src/
│   ├── app/                    # Next.js App Router
│   │   ├── api/               # API路由
│   │   │   └── generate-emoji/ # 表情包生成API
│   │   ├── globals.css        # 全局样式
│   │   ├── layout.tsx         # 根布局（SEO配置）
│   │   ├── page.tsx          # 主页
│   │   ├── robots.ts         # 动态robots.txt
│   │   └── sitemap.ts        # 动态sitemap.xml
│   ├── components/            # React组件
│   │   ├── PetEmojiGenerator.tsx # 主要生成器组件
│   │   ├── EmojiGallery.tsx     # 表情包画廊
│   │   └── ScrollButton.tsx     # 滚动按钮
│   └── lib/
│       └── supabase.ts        # 数据库客户端
├── public/                    # 静态资源
│   ├── manifest.json         # PWA配置
│   └── robots.txt           # 静态robots文件
├── docs/                     # 项目文档
└── scripts/                  # 数据库脚本
```

## 核心功能

### 1. 图片上传与处理
- **支持格式**: JPG, PNG, WebP
- **文件大小限制**: 5MB
- **上传方式**: 拖拽上传 + 点击上传
- **预览功能**: 实时图片预览
- **验证机制**: 文件类型和大小验证

### 2. AI表情包生成
- **AI模型**: 豆包大模型 (doubao-seedream-4-0-250828)
- **生成风格**: 4种风格（可爱、搞笑、生气、开心）
- **输出格式**: 3x3网格，9个表情的单张图片
- **存储**: Cloudflare R2对象存储
- **数据库**: Supabase PostgreSQL记录元数据

### 3. 频率限制系统
- **限制规则**: 每小时最多生成1张图片
- **实现方式**: 服务器端数据库查询验证
- **用户体验**: 友好的等待时间提示
- **自动恢复**: 限制时间过后自动解除

### 4. 表情包画廊
- **分页展示**: 支持无限滚动加载
- **筛选功能**: 按风格筛选表情包
- **响应式设计**: 适配各种屏幕尺寸
- **下载功能**: 支持表情包下载

## 数据库设计

### emoji_generations 表
```sql
CREATE TABLE emoji_generations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  style VARCHAR(20) NOT NULL CHECK (style IN ('cute', 'funny', 'angry', 'happy')),
  pet_type VARCHAR(50),
  image_url TEXT NOT NULL,
  image_size VARCHAR(20),
  doubao_model VARCHAR(100),
  doubao_request_id VARCHAR(100),
  generated_images INTEGER DEFAULT 1,
  tokens_used INTEGER,
  status VARCHAR(20) DEFAULT 'completed' CHECK (status IN ('completed', 'failed', 'processing')),
  error_message TEXT,
  is_public BOOLEAN DEFAULT true,
  featured BOOLEAN DEFAULT false
);
```

### 索引优化
```sql
CREATE INDEX idx_emoji_generations_created_at ON emoji_generations(created_at DESC);
CREATE INDEX idx_emoji_generations_style ON emoji_generations(style);
CREATE INDEX idx_emoji_generations_featured ON emoji_generations(featured) WHERE featured = true;
```

## API设计

### 生成表情包 API
**端点**: `POST /api/generate-emoji`

**请求体**:
```json
{
  "image": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...",
  "style": "cute"
}
```

**成功响应**:
```json
{
  "success": true,
  "emoji": {
    "id": "uuid",
    "url": "https://pub-a51a2574d6e74ec8b4c2cc453bfecf10.r2.dev/emoji-uuid.jpg",
    "style": "cute"
  }
}
```

**频率限制响应**:
```json
{
  "success": false,
  "rateLimited": true,
  "message": "服务器繁忙，请稍后再试！",
  "waitMinutes": 45,
  "remainingCount": 0
}
```

## SEO优化

### 元数据配置
- **标题**: "Pet Emoji Generator - Transform Your Pet Into Amazing Emojis"
- **描述**: 完整的产品描述和关键词
- **Open Graph**: 社交媒体分享优化
- **Twitter Card**: Twitter分享优化
- **Canonical URL**: 防止重复内容

### 结构化数据
```json
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Pet Emoji Generator",
  "description": "AI-powered pet emoji generator",
  "url": "https://www.petemojimaker.com",
  "applicationCategory": "MultimediaApplication"
}
```

### 技术SEO
- **Sitemap**: 动态生成XML sitemap
- **Robots.txt**: 搜索引擎爬虫指导
- **PWA支持**: manifest.json配置
- **性能优化**: Next.js Image组件，字体优化

## 环境变量配置

```env
# 豆包AI配置
DOUBAO_API_KEY=your_doubao_api_key

# Cloudflare R2配置
CLOUDFLARE_ACCOUNT_ID=your_account_id
CLOUDFLARE_R2_ACCESS_KEY_ID=your_access_key
CLOUDFLARE_R2_SECRET_ACCESS_KEY=your_secret_key
CLOUDFLARE_R2_PUBLIC_URL=https://pub-a51a2574d6e74ec8b4c2cc453bfecf10.r2.dev

# Supabase配置
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key

# 应用配置
NEXT_PUBLIC_BASE_URL=https://www.petemojimaker.com
```

## 部署与监控

### Vercel部署
- **平台**: Vercel
- **构建**: Next.js 15 + Turbopack
- **域名**: https://www.petemojimaker.com
- **HTTPS**: 自动SSL证书

### 性能优化
- **图片优化**: Next.js Image组件，WebP自动转换
- **字体优化**: Geist字体预加载
- **代码分割**: 自动代码分割和懒加载
- **CDN**: Cloudflare全球CDN加速

### 错误处理
- **前端**: 用户友好的错误提示
- **后端**: 完整的错误日志和状态码
- **数据库**: 连接失败时的降级处理
- **AI服务**: 超时和重试机制

## 安全性

### 数据安全
- **文件验证**: 严格的文件类型和大小检查
- **频率限制**: 防止API滥用
- **环境变量**: 敏感信息安全存储
- **CORS**: 适当的跨域配置

### 隐私保护
- **数据最小化**: 只收集必要的生成数据
- **临时存储**: 上传图片不永久保存
- **公开控制**: 用户可控制表情包是否公开展示

## 代码质量

### TypeScript
- **类型安全**: 完整的类型定义
- **接口设计**: 清晰的数据结构
- **错误处理**: 类型安全的错误处理

### 代码规范
- **ESLint**: Next.js推荐配置
- **组件化**: 可复用的React组件
- **Hooks**: 现代React开发模式
- **性能优化**: useCallback等性能优化钩子

## 未来扩展

### 功能扩展
- 更多AI模型支持
- 批量生成功能
- 用户账户系统
- 表情包编辑功能

### 技术升级
- 实时生成预览
- 移动端PWA优化
- 更多文件格式支持
- 高级图片处理功能

## 二、AI生成服务集成

### 2.1 API架构设计
**轻量级后端架构：**
- **Next.js API Routes**: 处理敏感API密钥，封装第三方服务调用
- **Vercel Serverless Functions**: 利用免费额度处理图片上传和AI生成
- **无数据库设计**: MVP阶段无需用户系统，降低复杂度

### 2.2 AI服务选择
**推荐方案：Hugging Face Inference API**
```javascript
// API调用示例
const response = await fetch('https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-xl-base-1.0', {
  headers: {
    'Authorization': `Bearer ${process.env.HF_API_TOKEN}`,
    'Content-Type': 'application/json',
  },
  method: 'POST',
  body: JSON.stringify({ 
    inputs: prompt,
    parameters: {
      num_inference_steps: 20,
      guidance_scale: 7.5,
      width: 512,
      height: 512
    }
  }),
});
```

**免费额度：**
- 每月30,000次请求
- 足够MVP阶段使用
- 超出后可考虑付费升级

### 2.3 提示词工程
**基础提示词模板：**
```javascript
const promptTemplates = {
  cute: "cute [pet_type] emoji, adorable expression, meme style, white background, high quality",
  funny: "funny [pet_type] emoji, comical expression, meme style, white background, high quality",
  angry: "angry [pet_type] emoji, grumpy expression, meme style, white background, high quality",
  happy: "happy [pet_type] emoji, cheerful expression, meme style, white background, high quality"
};

const negativePrompt = "blurry, low quality, deformed, ugly, extra limbs, bad anatomy, text, watermark";
```

**动态提示词生成：**
```javascript
function generatePrompt(petType, emotion, style = 'cute') {
  const basePrompt = promptTemplates[style] || promptTemplates.cute;
  return basePrompt
    .replace('[pet_type]', petType)
    .replace('[emotion]', emotion);
}
```

### 2.4 图片处理流程
**上传处理：**
1. 用户上传宠物照片
2. 客户端压缩和格式验证
3. 转换为base64发送到API
4. 生成多个表情版本

**生成优化：**
- 并行生成多个表情
- 缓存常用提示词结果
- 错误重试机制

## 三、图片存储与处理

### 3.1 存储策略
**MVP阶段存储方案：**
- **用户上传图片**: 临时存储，生成后立即删除
- **生成的表情包**: 临时存储，用户下载后删除
- **存储服务**: Vercel Blob（免费额度）或Cloudinary（免费额度）

**存储流程：**
```javascript
// 上传处理示例
export default async function handler(req, res) {
  const { image, prompt } = req.body;
  
  // 1. 验证图片格式和大小
  if (!isValidImage(image)) {
    return res.status(400).json({ error: 'Invalid image format' });
  }
  
  // 2. 生成表情包
  const emojis = await generateEmojis(prompt);
  
  // 3. 返回base64编码的图片
  return res.json({ emojis });
}
```

### 3.2 图片优化
**客户端优化：**
- **压缩上传**: 客户端压缩图片减少传输时间
- **格式转换**: 统一转换为WebP格式
- **尺寸限制**: 限制上传图片最大尺寸

**服务端优化：**
- **缓存机制**: 缓存相同提示词的结果
- **批量生成**: 一次生成多个表情版本
- **错误处理**: 友好的错误提示和重试机制

### 3.3 安全性考虑
**上传安全：**
- MIME类型验证
- 文件大小限制（最大5MB）
- 图片内容检测

**API安全：**
- 环境变量存储API密钥
- 请求频率限制
- CORS配置

## 四、部署与SEO优化

### 4.1 部署配置
**Vercel部署：**
```json
// vercel.json
{
  "functions": {
    "app/api/**/*.js": {
      "maxDuration": 30
    }
  },
  "env": {
    "HF_API_TOKEN": "@hf-api-token"
  }
}
```

**环境变量配置：**
- `HF_API_TOKEN`: Hugging Face API密钥
- `NEXT_PUBLIC_SITE_URL`: 网站URL
- `GOOGLE_ADSENSE_CLIENT`: AdSense客户端ID（后续添加）

### 4.2 SEO优化实现
**页面元数据：**
```javascript
// app/layout.tsx
export const metadata = {
  title: 'Pet Emoji Generator - Transform Your Pet Into Amazing Emojis',
  description: 'Create AI-generated pet emojis from your pet photos. Free, fast, and fun! Upload your pet photo and get cute emoji versions instantly.',
  keywords: 'pet emoji, AI pet generator, pet meme, cute pet emoji, pet photo to emoji',
  openGraph: {
    title: 'Pet Emoji Generator - AI Pet Emoji Maker',
    description: 'Transform your pet photos into adorable emojis with AI',
    images: ['/og-image.jpg'],
  },
  twitter: {
    card: 'summary_large_image',
    title: 'Pet Emoji Generator',
    description: 'Transform your pet photos into adorable emojis with AI',
  }
};
```

**结构化数据：**
```javascript
// 添加JSON-LD结构化数据
const structuredData = {
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "Pet Emoji Generator",
  "description": "AI-powered pet emoji generator",
  "url": "https://pet-emoji.com",
  "applicationCategory": "MultimediaApplication",
  "operatingSystem": "Web Browser"
};
```

### 4.3 AdSense集成准备
**广告组件：**
```javascript
// components/AdSense.js
import Script from 'next/script';

export default function AdSense({ slot, format = 'auto' }) {
  return (
    <>
      <Script
        async
        src={`https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-${process.env.NEXT_PUBLIC_ADSENSE_CLIENT}`}
        strategy="afterInteractive"
      />
      <ins
        className="adsbygoogle"
        style={{ display: 'block' }}
        data-ad-client={`ca-pub-${process.env.NEXT_PUBLIC_ADSENSE_CLIENT}`}
        data-ad-slot={slot}
        data-ad-format={format}
        data-full-width-responsive="true"
      />
    </>
  );
}
```

**广告位置：**
- Hero Section下方
- 结果展示区域下方
- 页面底部

## 五、成本控制与监控

### 5.1 免费资源利用
**Vercel免费额度：**
- 每月100GB带宽
- 100GB函数执行时间
- 无限静态文件托管

**Hugging Face免费额度：**
- 每月30,000次API调用
- 足够MVP阶段使用

**存储免费额度：**
- Vercel Blob: 1GB存储
- Cloudinary: 25GB存储，25GB带宽

### 5.2 成本监控
**API使用监控：**
```javascript
// 添加使用统计
const trackUsage = async (endpoint, cost) => {
  // 记录API调用次数和成本
  console.log(`API call to ${endpoint}, estimated cost: ${cost}`);
};
```

**成本预警：**
- 设置API调用次数阈值
- 监控免费额度使用情况
- 超出时考虑付费升级

### 5.3 性能优化
**前端优化：**
- Next.js Image组件自动优化
- 代码分割和懒加载
- 静态资源CDN加速

**后端优化：**
- API响应缓存
- 并行处理多个请求
- 错误重试机制
